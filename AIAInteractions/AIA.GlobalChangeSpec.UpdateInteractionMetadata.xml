<GlobalChangeSpec
  xmlns="bb_appfx_globalchange"
  xmlns:c="bb_appfx_commontypes"
  ID="417da8fb-fa89-4e73-938f-ea9ae93135fa"
  Name="Update interaction metadata (AIA)"
  Description="Updates interaction metadata fields."
  Author="Danny Smith (AIA)"
  DisplayName="Update interaction metadata (AIA)"
  GlobalChangeFolder="Constituent\Interaction"
  SPName="USR_AIA_USP_GLOBALCHANGE_UPDATEINTERACTION"
>

  <!-- describe the SP that performs the global change operation -->
  <CreateProcedureSQL>
    <![CDATA[
create procedure dbo.USR_AIA_USP_GLOBALCHANGE_UPDATEINTERACTION
(
  @IDSETREGISTERID uniqueidentifier               = null,
  @CHANGEAGENTID uniqueidentifier                 = null,
  @ASOF as datetime                               = null,
  @NUMBERADDED int                                = 0 output,
  @NUMBEREDITED int                               = 0 output,
  @NUMBERDELETED int                              = 0 output,
  @SUMMARY nvarchar(100)                          = '' output,
  @STATUSCODE tinyint                             = 0 output,
  @EXPECTEDDATE datetime                          = null output,
  @EXPECTEDDATERELATIVE bit                       = null output,
  @EXPECTEDDATEDAYS int                           = null output,
  @ACTUALDATE datetime                            = null output,
  @ACTUALDATERELATIVE bit                         = null output,
  @ACTUALDATEDAYS int                             = null output,
  @OWNER uniqueidentifier                         = null output,
  @INTERACTIONTYPECODEID uniqueidentifier         = null output,
  @INTERACTIONCATEGORYID uniqueidentifier         = null output,
  @INTERACTIONSUBCATEGORYID uniqueidentifier      = null output,
  @COMMENT nvarchar(max)                          = '' output
)
as      
  set nocount off;

  declare @CURRENTDATE datetime
  set @CURRENTDATE   = getdate();
  set @NUMBERADDED   = 0;
  set @NUMBEREDITED  = 0;
  set @NUMBERDELETED = 0; 

  if @CHANGEAGENTID is null
    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @CHANGEAGENTID output;

  if @EXPECTEDDATERELATIVE = 1
    set @EXPECTEDDATE = cast(DATEADD(day, @EXPECTEDDATEDAYS, GETDATE()) as date);

  if @ACTUALDATERELATIVE = 1
    set @ACTUALDATE = cast(DATEADD(day, @ACTUALDATEDAYS, GETDATE()) as date);

  begin try
    update 
      intr
    set  
      intr.STATUSCODE = case when @STATUSCODE = 0 or @STATUSCODE is null then intr.STATUSCODE else @STATUSCODE end,
      intr.OBJECTIVE = case when @SUMMARY = '' or @SUMMARY is null then intr.OBJECTIVE else @SUMMARY end,
      intr.ACTUALDATE = case when @ACTUALDATE is null then intr.ACTUALDATE else @ACTUALDATE end,
      intr.EXPECTEDDATE = case when @EXPECTEDDATE is null then intr.EXPECTEDDATE else @EXPECTEDDATE end,
      intr.FUNDRAISERID = case when @OWNER is null then intr.FUNDRAISERID else @OWNER end,
      intr.INTERACTIONTYPECODEID = case when @INTERACTIONTYPECODEID is null then intr.INTERACTIONTYPECODEID else @INTERACTIONTYPECODEID end,
      intr.INTERACTIONSUBCATEGORYID = case when @INTERACTIONSUBCATEGORYID is null then intr.INTERACTIONSUBCATEGORYID else @INTERACTIONSUBCATEGORYID end,
      intr.COMMENT = case when @COMMENT = '' or @COMMENT is null then intr.COMMENT else @COMMENT end 

    from 
      dbo.[UFN_IDSETREADER_GETRESULTS_GUID](@IDSETREGISTERID) Id
    inner join 
      dbo.INTERACTION intr on intr.ID = Id.ID
    set 
      @NUMBEREDITED = @@ROWCOUNT
  end try

  begin catch
    exec dbo.USP_RAISE_ERROR;
    return 1;
  end catch
    ]]>
  </CreateProcedureSQL>

  <ExpectedDBExceptions>
    <CustomExceptions xmlns="bb_appfx_commontypes">
      <Exception SearchText="UFN_IDSETREADER_GETRESULTS_GUID" CustomErrorMsgResourceKey="$$an_invalid_selection_was_specified_for_this_global_change">
        <CustomErrorMsg>An invalid selection was specified for this global change.</CustomErrorMsg>
      </Exception>
      <Exception SearchText="CK_INTERACTION_ACTUALDATEPRESENTONLYWHENCOMPLETE">
        <CustomErrorMsg>Some interactions in the provided selection are not Completed, but Actual date can only be set for Completed interactions. Please update the selection before trying again.</CustomErrorMsg>
      </Exception>
    </CustomExceptions>
  </ExpectedDBExceptions>

  <ParametersFormMetaData>
    <FormMetaData xmlns="bb_appfx_commontypes">
      <FormFields>
        <FormField FieldID="IDSETREGISTERID" DataType="Guid" Required="true" Caption="Selection">
          <SearchList SearchListID="98d0070e-c4a7-495b-a438-2ac12da79068" EnableQuickFind="true">
            <FormFieldOverrides>
              <FormFieldOverride FieldID="RECORDTYPEID" Caption="Record type" ReadOnly="true" DefaultValueText="Fields!RECORDTYPEID" />
            </FormFieldOverrides>
          </SearchList>
        </FormField>
        <FormField FieldID="RECORDTYPEID" DataType="Guid" ReadOnly="true" Hidden="true" />
        <FormField FieldID="STATUSCODE" DataType="TinyInt" Caption="Status">
          <ValueList>
            <Items>
              <Item LabelResourceKey="$$pending">
                <Value>1</Value>
                <Label>Pending</Label>
              </Item>
              <Item LabelResourceKey="$$completed">
                <Value>2</Value>
                <Label>Completed</Label>
              </Item>
              <Item LabelResourceKey="$$canceled">
                <Value>4</Value>
                <Label>Canceled</Label>
              </Item>
              <Item LabelResourceKey="$$declined">
                <Value>5</Value>
                <Label>Declined</Label>
              </Item>
            </Items>
          </ValueList>
        </FormField>
        <FormField FieldID="SUMMARY" MaxLength="100" Caption="Summary" DefaultValueText="" CaptionResourceKey="$$summary" />
        <FormField FieldID="EXPECTEDDATE" DataType="Date" Caption="Expected date" CaptionResourceKey="$$expected_date" />
        <FormField FieldID="EXPECTEDDATERELATIVE" DataType="Boolean" Caption="Relative date" />
        <FormField FieldID="EXPECTEDDATEDAYS" DataType="Integer" Caption="Days from today" />
        <FormField FieldID="ACTUALDATE" DataType="Date" Caption="Actual date" CaptionResourceKey="$$actual_date" />
        <FormField FieldID="ACTUALDATERELATIVE" DataType="Boolean" Caption="Relative date" />
        <FormField FieldID="ACTUALDATEDAYS" DataType="Integer" Caption="Days from today" />
        <FormField FieldID="OWNER" DataType="Guid" Caption="Owner">
          <SearchList SearchListID="23c5c603-d7d8-4106-aecc-65392b563887" EnableQuickFind="true">
            <FormFieldOverrides>
              <FormFieldOverride FieldID="INCLUDEORGANIZATIONS" Caption="Organizations" ReadOnly="true" DefaultValueText="False" />
              <FormFieldOverride FieldID="EXCLUDEHOUSEHOLDS" Caption="EXCLUDEHOUSEHOLDS" Hidden="true" DefaultValueText="True" />
              <FormFieldOverride FieldID="INCLUDENONCONSTITUENTRECORDS" DefaultValueText="true" />
              <FormFieldOverride FieldID="FORMHEADER" DefaultValueText="Record Search" />
            </FormFieldOverrides>
          </SearchList>
        </FormField>
        <FormField FieldID="INTERACTIONTYPECODEID" DataType="Guid" Caption="Contact method">
          <CodeTable CodeTableName="INTERACTIONTYPECODE" />
        </FormField>
        <FormField FieldID="INTERACTIONCATEGORYID" DataType="Guid" Caption="Category">
          <SimpleDataList SimpleDataListID="cbba7545-b66f-44ac-aa24-d9c2f8cbc4ec" />
        </FormField>
        <FormField FieldID="INTERACTIONSUBCATEGORYID" DataType="Guid" Caption="Subcategory">
          <SimpleDataList SimpleDataListID="0eacc39b-07d1-4641-8774-e319559535a7">
            <Params>
              <Param ID="INTERACTIONCATEGORYID">
                <Value>Fields!INTERACTIONCATEGORYID</Value>
              </Param>
            </Params>
          </SimpleDataList>
        </FormField>
        <FormField FieldID="COMMENT" Caption="Comment" DefaultValueText="" Multiline="true" />
      </FormFields>
      <WebUIComponent>
        <UIModel AssemblyName="AIAInteractionsUIModel.dll" ClassName="AIAInteractionsUIModel.AIAUpdateInteractionMetadataUIModel" />
        <WebUI>
          <ExternalResource Url="browser/htmlforms/custom/AIA/AIAUpdateInteractionMetadata.html" />
        </WebUI>
      </WebUIComponent>
      <UIActions>
        <UIAction ActionID="QUERYEDIT">
          <ShowEditQueryForm LinkedFieldId="IDSETREGISTERID" />
        </UIAction>
      </UIActions>
    </FormMetaData>
  </ParametersFormMetaData>
</GlobalChangeSpec>
