<GlobalChangeSpec 
  xmlns="bb_appfx_globalchange"
  xmlns:c="bb_appfx_commontypes"
  ID="c443f705-3595-41ba-bd27-3782d3cb4edb"
  Name="Add interaction attribute (AIA)"
  Description="Adds an attribute to an interaction record"
  Author="Danny Smith (AIA)"
  DisplayName="Add interaction attribute (AIA)"
  GlobalChangeFolder="Constituent\Interaction"
  SPName="USR_AIA_USP_GLOBALCHANGE_ADDINTERACTIONATTRIBUTE"
>

  <!-- describe the SP that performs the global change operation -->
  <CreateProcedureSQL>
    <![CDATA[
create procedure dbo.USR_AIA_USP_GLOBALCHANGE_ADDINTERACTIONATTRIBUTE
(
  @IDSETREGISTERID uniqueidentifier = null, 
  @ATTRIBUTECATEGORYID uniqueidentifier,
  @STRINGVALUE nvarchar(250) = null,
  @NUMBERVALUE int = null,
  @MONEYVALUE money = null,
  @DATEVALUE datetime = null,
  @BOOLEANVALUE bit = null,
  @CODETABLEVALUE uniqueidentifier = null,
  @FUZZYDATEVALUE udt_fuzzydate = null,
  @CONSTITUENTIDVALUE uniqueidentifier = null,
  @HOURMINUTEVALUE udt_hourminute = null,
  @MEMOVALUE nvarchar(max) = null,
  @COMMENT nvarchar(255) = null,
  @REMOVEUNQUALIFIED bit,
  @OVERWRITEEXISTINGVALUE bit,
  @CHANGEAGENTID uniqueidentifier = null,
  @ASOF as datetime = null,
  @NUMBERADDED int = 0 output,
  @NUMBEREDITED int = 0 output,
  @NUMBERDELETED int = 0 output,
  @CURRENTAPPUSERID uniqueidentifier = null,
  @CURRENCYID uniqueidentifier = null,
  @STARTDATE datetime = null,
  @ENDDATE datetime = null
)
as      
  set nocount off;
  
  declare @DATATYPE int
  declare @ATTRIBUTETABLENAME nvarchar(128)
  declare @INSERTSQL nvarchar(max)
  declare @UPDATESQL nvarchar(max)
  declare @PARAMETERDEFINITION nvarchar(500)
  declare @CURRENTDATE datetime
  declare @ONEPERRECORD bit
  declare @VALUECOLUMNNAME nvarchar(128)
  
  set @NUMBERADDED = 0;
  set @NUMBEREDITED = 0;
  set @NUMBERDELETED = 0; 
  set @UPDATESQL = '';
  
  set @CURRENTDATE = getdate();
  
  if @CURRENCYID is null
    set @CURRENCYID = dbo.UFN_CURRENCY_GETORGANIZATIONCURRENCY();
                    
  if @CHANGEAGENTID is null begin
    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @CHANGEAGENTID output;
  end
  
  select 
    @DATATYPE = ATTRIBUTECATEGORY.DATATYPECODE, 
    @ATTRIBUTETABLENAME = TABLECATALOG.TABLENAME, 
    @ONEPERRECORD = ATTRIBUTECATEGORY.ONLYALLOWONEPERRECORD,
    @VALUECOLUMNNAME = ATTRIBUTECATEGORY.VALUECOLUMNNAME
  from 
    dbo.ATTRIBUTECATEGORY 
    inner join dbo.TABLECATALOG on TABLECATALOG.ID = ATTRIBUTECATEGORY.TABLECATALOGID 
  where 
    ATTRIBUTECATEGORY.ID = @ATTRIBUTECATEGORYID;
  
  set @PARAMETERDEFINITION = '@COMMENTPARAMETER nvarchar(255), @CHANGEAGENTIDPARAMETER uniqueidentifier, @CURRENTDATEPARAMETER datetime, @STARTDATEPARAMETER datetime, @ENDDATEPARAMETER datetime';
  if @DATATYPE = 3
    set @PARAMETERDEFINITION = '@CURRENCYIDPARAMETER uniqueidentifier, ' + @PARAMETERDEFINITION;
    
  declare @SELECTIONTABLESQL nvarchar(200);
  declare @SELECTION nvarchar(43);
  set @SELECTION = '';
  
  if @IDSETREGISTERID is not null begin
    declare @IDSETPARAMETERDEFINITION nvarchar(500);
    set @IDSETPARAMETERDEFINITION = '@IDSETREGISTERIDPARAMETER uniqueidentifier';
    
    select @SELECTION = '##SELECTION' + replace(cast(newid() as nvarchar(36)),'-','')
        
    set @SELECTIONTABLESQL = 'create table ' + @SELECTION + '(ID UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)';
    exec sp_executesql @SELECTIONTABLESQL;
    
    declare @IDSETREGISTERSQL nvarchar(max);
    
    begin
      --insert all records from the selection
      set @IDSETREGISTERSQL = 'insert into ' + @SELECTION + '(ID) select ID from dbo.UFN_IDSETREADER_GETRESULTS_GUID(@IDSETREGISTERIDPARAMETER)';
      exec sp_executesql @IDSETREGISTERSQL, @IDSETPARAMETERDEFINITION, @IDSETREGISTERIDPARAMETER = @IDSETREGISTERID;
    end

    --AdamBu - Bug 40526 - If the selection used is static, make sure none of the records it contains have been deleted.
    if exists(
      select 1
      from dbo.IDSETREGISTER
      where ID = @IDSETREGISTERID and STATIC = 1
    )
    begin
      declare @STATICSQL nvarchar(max) = 'delete ' + @SELECTION + ' where ID not in(select ID from INTERACTION);'
      exec sp_executesql @STATICSQL
    end
  end
  
  /* If @REMOVEUNQUALIFIED is true and and id set is selected then delete all records from the attribute table that are not in the id set.*/
  if @IDSETREGISTERID is not null and @REMOVEUNQUALIFIED = 1 begin
    declare @DELETESQL nvarchar(max);
    
    if @ONEPERRECORD = 1  
      begin
        set @DELETESQL = 'delete from dbo.[' + @ATTRIBUTETABLENAME + '] where ID in
        (
          select SELECTEDINTERACTION.ID 
          from dbo.[' + @ATTRIBUTETABLENAME + '] SELECTEDINTERACTION ' + 
            ' where SELECTEDINTERACTION.ID not in(select ID from ' + @SELECTION + ')
        )';
      end
    else  
      begin
        set @DELETESQL = 'delete from dbo.[' + @ATTRIBUTETABLENAME + '] where INTERACTIONID in
        (
          select SELECTEDINTERACTION.INTERACTIONID 
          from dbo.[' + @ATTRIBUTETABLENAME + '] SELECTEDINTERACTION ' + 
            ' where SELECTEDINTERACTION.INTERACTIONID not in(select ID from ' + @SELECTION + ')
        )';
      end

    declare @CONTEXTCACHE varbinary(128);

    /* Cache current context information@ */
    set @CONTEXTCACHE = CONTEXT_INFO();

    /* Set CONTEXT_INFO to @CHANGEAGENTID */
    set CONTEXT_INFO @CHANGEAGENTID;
      
    /* delete records */
    exec sp_executesql @DELETESQL;
    set @NUMBERDELETED = @@ROWCOUNT;
    
    /* Reset CONTEXT_INFO to previous value */
    if not @contextCache is null
      set CONTEXT_INFO @CONTEXTCACHE;
  end
    
  if @IDSETREGISTERID is not null
    begin
      if @ONEPERRECORD = 1
        begin
          set @INSERTSQL = 'insert into dbo.[' + @ATTRIBUTETABLENAME + '] (ID, ' + @VALUECOLUMNNAME + ', ';
          if @DATATYPE = 3
            set @INSERTSQL = @INSERTSQL + 'CURRENCYID, ';
          set @INSERTSQL = @INSERTSQL + 'COMMENT, ADDEDBYID, CHANGEDBYID, DATEADDED, DATECHANGED, STARTDATE, ENDDATE) select SELECTION.ID, @VALUEPARAMETER, ';
          if @DATATYPE = 3
            set @INSERTSQL = @INSERTSQL + '@CURRENCYIDPARAMETER, ';
          set @INSERTSQL = @INSERTSQL + '@COMMENTPARAMETER, @CHANGEAGENTIDPARAMETER, @CHANGEAGENTIDPARAMETER, @CURRENTDATEPARAMETER, @CURRENTDATEPARAMETER, @STARTDATEPARAMETER, @ENDDATEPARAMETER from ' + @SELECTION + ' as SELECTION';
          
          /* We don't want to add a duplicate attribute value so we need to check if the value already exists before inserting the record. */
          set @INSERTSQL = @INSERTSQL + ' where SELECTION.ID not in(select ID from dbo.[' + @ATTRIBUTETABLENAME + '])'
        
          /* If overwriting the existing value we must only insert records that don't already exist in the attribute table */
          if @OVERWRITEEXISTINGVALUE = 1 begin
            set @UPDATESQL = 'update dbo.[' + @ATTRIBUTETABLENAME + '] set ' + @VALUECOLUMNNAME + ' = @VALUEPARAMETER, ';
            if @DATATYPE = 3
              set @UPDATESQL = @UPDATESQL + 'CURRENCYID = @CURRENCYIDPARAMETER, ';
            set @UPDATESQL = @UPDATESQL + 'COMMENT = @COMMENTPARAMETER, CHANGEDBYID = @CHANGEAGENTIDPARAMETER, DATECHANGED = @CURRENTDATEPARAMETER, STARTDATE = @STARTDATEPARAMETER, ENDDATE = @ENDDATEPARAMETER where [' + @ATTRIBUTETABLENAME + '].ID in (select ID from ' + @SELECTION + ')'
          end
        end
      else
        begin
          set @INSERTSQL = 'insert into dbo.[' + @ATTRIBUTETABLENAME + '] (ID, INTERACTIONID, ' + @VALUECOLUMNNAME + ', ';
          if @DATATYPE = 3
            set @INSERTSQL = @INSERTSQL + 'CURRENCYID, ';
          set @INSERTSQL = @INSERTSQL + 'COMMENT, ADDEDBYID, CHANGEDBYID, DATEADDED, DATECHANGED, STARTDATE, ENDDATE) select newid(), SELECTION.ID, @VALUEPARAMETER, ';
          if @DATATYPE = 3
            set @INSERTSQL = @INSERTSQL + '@CURRENCYIDPARAMETER, ';
          set @INSERTSQL = @INSERTSQL + '@COMMENTPARAMETER, @CHANGEAGENTIDPARAMETER, @CHANGEAGENTIDPARAMETER, @CURRENTDATEPARAMETER, @CURRENTDATEPARAMETER, @STARTDATEPARAMETER, @ENDDATEPARAMETER from ' + @SELECTION + ' as SELECTION';
          
          /* If overwriting the existing value we must only insert records that don't already exist in the attribute table */
          if @OVERWRITEEXISTINGVALUE = 1 begin
          
            /* Don't insert new values for entries that will be overwritten */
            set @INSERTSQL = @INSERTSQL + ' where SELECTION.ID not in(select INTERACTIONID from dbo.[' + @ATTRIBUTETABLENAME + '])'
          
            set @UPDATESQL = 'update dbo.[' + @ATTRIBUTETABLENAME + '] set ' + @VALUECOLUMNNAME + ' = @VALUEPARAMETER, ';
            if @DATATYPE = 3
              set @UPDATESQL = @UPDATESQL + 'CURRENCYID = @CURRENCYIDPARAMETER, ';
            set @UPDATESQL = @UPDATESQL + 'COMMENT = @COMMENTPARAMETER, CHANGEDBYID = @CHANGEAGENTIDPARAMETER, DATECHANGED = @CURRENTDATEPARAMETER, STARTDATE = @STARTDATEPARAMETER, ENDDATE = @ENDDATEPARAMETER where [' + @ATTRIBUTETABLENAME + '].INTERACTIONID in (select ID from ' + @SELECTION + ')'
          end
        end
    end
  else
    begin
      if @ONEPERRECORD = 1
        begin
          set @INSERTSQL = 'insert into dbo.[' + @ATTRIBUTETABLENAME + '] (ID, ' + @VALUECOLUMNNAME + ', ';
          if @DATATYPE = 3
            set @INSERTSQL = @INSERTSQL + 'CURRENCYID, ';
          set @INSERTSQL = @INSERTSQL + 'COMMENT, ADDEDBYID, CHANGEDBYID, DATEADDED, DATECHANGED, STARTDATE, ENDDATE) select SELECTEDINTERACTION.ID, @VALUEPARAMETER, ';
          if @DATATYPE = 3
            set @INSERTSQL = @INSERTSQL + '@CURRENCYIDPARAMETER, ';
          set @INSERTSQL = @INSERTSQL + '@COMMENTPARAMETER, @CHANGEAGENTIDPARAMETER, @CHANGEAGENTIDPARAMETER, @CURRENTDATEPARAMETER, @CURRENTDATEPARAMETER, @STARTDATEPARAMETER, @ENDDATEPARAMETER from dbo.INTERACTION SELECTEDINTERACTION ';
          
          /* We don't want to add a duplicate attribute value so we need to check if the value already exists before inserting the record. */
          set @INSERTSQL = @INSERTSQL + ' where SELECTEDINTERACTION.ID not in(select ID from dbo.[' + @ATTRIBUTETABLENAME + '])';
            
          /* If overwriting the existing value we must only insert records that don't already exist in the attribute table */
          if @OVERWRITEEXISTINGVALUE = 1 begin
            set @UPDATESQL = 'update dbo.[' + @ATTRIBUTETABLENAME + '] set ' + @VALUECOLUMNNAME + ' = @VALUEPARAMETER, ';
            if @DATATYPE = 3
              set @UPDATESQL = @UPDATESQL + 'CURRENCYID = @CURRENCYIDPARAMETER, ';
            set @UPDATESQL = @UPDATESQL + 'COMMENT = @COMMENTPARAMETER, CHANGEDBYID = @CHANGEAGENTIDPARAMETER, DATECHANGED = @CURRENTDATEPARAMETER, STARTDATE = @STARTDATEPARAMETER, ENDDATE = @ENDDATEPARAMETER from dbo.[' + @ATTRIBUTETABLENAME + '] SELECTEDINTERACTION ';
          end
        end
      else
        begin
          set @INSERTSQL = 'insert into dbo.[' + @ATTRIBUTETABLENAME + '] (ID, INTERACTIONID, ' + @VALUECOLUMNNAME + ', ';
          if @DATATYPE = 3
            set @INSERTSQL = @INSERTSQL + 'CURRENCYID, ';
          set @INSERTSQL = @INSERTSQL + 'COMMENT, ADDEDBYID, CHANGEDBYID, DATEADDED, DATECHANGED, STARTDATE, ENDDATE) select newid(), SELECTEDINTERACTION.ID, @VALUEPARAMETER, ';
          if @DATATYPE = 3
            set @INSERTSQL = @INSERTSQL + '@CURRENCYIDPARAMETER, ';
          set @INSERTSQL = @INSERTSQL + '@COMMENTPARAMETER, @CHANGEAGENTIDPARAMETER, @CHANGEAGENTIDPARAMETER, @CURRENTDATEPARAMETER, @CURRENTDATEPARAMETER, @STARTDATEPARAMETER, @ENDDATEPARAMETER from dbo.INTERACTION SELECTEDINTERACTION ';
          
          /* If overwriting the existing value we must only insert records that don't already exist in the attribute table */
          if @OVERWRITEEXISTINGVALUE = 1 begin  
            
            /* Don't insert new values for entries that will be overwritten */
            set @INSERTSQL = @INSERTSQL + ' where SELECTEDINTERACTION.ID not in(select INTERACTIONID from dbo.[' + @ATTRIBUTETABLENAME + '])';
            
            set @UPDATESQL = 'update dbo.[' + @ATTRIBUTETABLENAME + '] set ' + @VALUECOLUMNNAME + ' = @VALUEPARAMETER, ';
            if @DATATYPE = 3
              set @UPDATESQL = @UPDATESQL + 'CURRENCYID = @CURRENCYIDPARAMETER, ';
            set @UPDATESQL = @UPDATESQL + 'COMMENT = @COMMENTPARAMETER, CHANGEDBYID = @CHANGEAGENTIDPARAMETER, DATECHANGED = @CURRENTDATEPARAMETER, STARTDATE = @STARTDATEPARAMETER, ENDDATE = @ENDDATEPARAMETER from dbo.[' + @ATTRIBUTETABLENAME + '] SELECTEDINTERACTION ';
          end
        end
    end

  begin try
    /* @VALUEPARAMETER definition must change based on attribute data type */
    if @DATATYPE = 0 
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER nvarchar(250)';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @STRINGVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @STRINGVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBERADDED = @@ROWCOUNT;
      end

    else if @DATATYPE = 1 
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER int';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @NUMBERVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @NUMBERVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBERADDED = @@ROWCOUNT;
      end
    
    else if @DATATYPE = 2 
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER datetime';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @DATEVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @DATEVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBERADDED = @@ROWCOUNT;
      end

    else if @DATATYPE = 3 
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER money';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION, @CURRENCYIDPARAMETER = @CURRENCYID, @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @MONEYVALUE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION, @CURRENCYIDPARAMETER = @CURRENCYID, @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @MONEYVALUE;
        set @NUMBERADDED = @@ROWCOUNT;
      end

    else if @DATATYPE = 4 
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER bit';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @BOOLEANVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @BOOLEANVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBERADDED = @@ROWCOUNT;
      end

    else if @DATATYPE = 5 
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER uniqueidentifier';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @CODETABLEVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @CODETABLEVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBERADDED = @@ROWCOUNT;
      end

    else if @DATATYPE = 6 
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER uniqueidentifier';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @CONSTITUENTIDVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @CONSTITUENTIDVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBERADDED = @@ROWCOUNT;
      end

    else if @DATATYPE = 7 
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER udt_fuzzydate';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @FUZZYDATEVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @FUZZYDATEVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBERADDED = @@ROWCOUNT;
      end

    else if @DATATYPE = 8
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER udt_hourminute';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @HOURMINUTEVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @HOURMINUTEVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBERADDED = @@ROWCOUNT;
      end

    else if @DATATYPE = 9 
      begin
        set @PARAMETERDEFINITION = @PARAMETERDEFINITION + ', @VALUEPARAMETER nvarchar(max)';
        
        if @UPDATESQL <> '' begin
          exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @MEMOVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
          set @NUMBEREDITED = @@ROWCOUNT;
        end
    
        exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @VALUEPARAMETER = @MEMOVALUE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBERADDED = @@ROWCOUNT;
      end
      
    if @SELECTION <> '' begin
      set @SELECTIONTABLESQL = 'drop table ' + @SELECTION;
      exec sp_executesql @SELECTIONTABLESQL 
    end
  end try
  
  begin catch
    if @SELECTION <> '' begin
      set @SELECTIONTABLESQL = 'drop table ' + @SELECTION;
      exec sp_executesql @SELECTIONTABLESQL 
    end
    
    exec dbo.USP_RAISE_ERROR;
    return 1;
  end catch
    ]]>
  </CreateProcedureSQL>

  <ExpectedDBExceptions>
    <CustomExceptions xmlns="bb_appfx_commontypes">
      <Exception SearchText="UFN_IDSETREADER_GETRESULTS_GUID" CustomErrorMsgResourceKey="$$an_invalid_selection_was_specified_for_this_global_change">
        <CustomErrorMsg>An invalid selection was specified for this global change.</CustomErrorMsg>
      </Exception>
    </CustomExceptions>
  </ExpectedDBExceptions>

  <ParametersFormMetaData>
    <FormMetaData xmlns="bb_appfx_commontypes">
      <FormFields>
        <FormField FieldID="IDSETREGISTERID" DataType="Guid" Caption="Selection" CaptionResourceKey="$$selection">
          <SearchList SearchListID="98d0070e-c4a7-495b-a438-2ac12da79068" EnableQuickFind="true">
            <FormFieldOverrides>
              <FormFieldOverride FieldID="RECORDTYPEID" Caption="Record type" ReadOnly="true" DefaultValueText="Fields!RECORDTYPEID" />
            </FormFieldOverrides>
          </SearchList>
        </FormField>
        <FormField FieldID="RECORDTYPEID" DataType="Guid" ReadOnly="true" Hidden="true" />
        <FormField FieldID="ATTRIBUTECATEGORYID" DataType="Guid" Required="true" Caption="Category" CaptionResourceKey="$$category">
          <SimpleDataList SimpleDataListID="958132a3-762a-4844-b7a1-f3a3098da95a">
            <Params>
              <Param ID="RECORDTYPE">
                <Value>Interaction</Value>
              </Param>
            </Params>
          </SimpleDataList>
        </FormField>
        <FormField FieldID="STRINGVALUE" MaxLength="250" Caption="Value" CaptionResourceKey="$$value" />
        <FormField FieldID="NUMBERVALUE" DataType="Integer" Caption="Value" CaptionResourceKey="$$value" />
        <FormField FieldID="MONEYVALUE" DataType="Money" Caption="Value" CaptionResourceKey="$$value">
          <CurrencyField CurrencyFieldID="CURRENCYID" />
        </FormField>
        <FormField FieldID="DATEVALUE" DataType="Date" Caption="Value" CaptionResourceKey="$$value" />
        <FormField FieldID="BOOLEANVALUE" DataType="TinyInt" Caption="Value" CaptionResourceKey="$$value">
          <ValueList>
            <Items>
              <Item LabelResourceKey="$$no">
                <Value>0</Value>
                <Label>No</Label>
              </Item>
              <Item LabelResourceKey="$$yes">
                <Value>1</Value>
                <Label>Yes</Label>
              </Item>
            </Items>
          </ValueList>
        </FormField>
        <FormField FieldID="CODETABLEVALUE" DataType="Guid" Caption="Value" CaptionResourceKey="$$value">
          <CodeTable CodeTableName="ADDRESSTYPECODE" />
        </FormField>
        <FormField FieldID="FUZZYDATEVALUE" DataType="FuzzyDate" Caption="Value" CaptionResourceKey="$$value" />
        <FormField FieldID="CONSTITUENTIDVALUE" DataType="Guid" Caption="Value" CaptionResourceKey="$$value">
          <SearchList SearchListID="23c5c603-d7d8-4106-aecc-65392b563887" EnableQuickFind="true">
            <AddDataForms>
              <AddDataForm ID="1986f0cf-efb6-48b3-afde-950b57562434" Caption="Individual" CaptionResourceKey="$$individual" />
              <AddDataForm ID="d846a816-46c7-470e-9ad0-973b2730e836" Caption="Household" CaptionResourceKey="$$household" />
              <AddDataForm ID="f0f6426a-fccd-48bb-846b-eb3d1a4a0ed4" Caption="Group" CaptionResourceKey="$$group" />
              <AddDataForm ID="ca3ed110-a5f0-4b5b-8eb7-0616e0a82e8e" Caption="Organization" CaptionResourceKey="$$organization" />
            </AddDataForms>
          </SearchList>
        </FormField>
        <FormField FieldID="HOURMINUTEVALUE" DataType="HourMinute" Caption="Value" CaptionResourceKey="$$value" />
        <FormField FieldID="MEMOVALUE" Caption="Value" CaptionResourceKey="$$value" />
        <FormField FieldID="ATTRIBUTECATEGORIES" ReadOnly="true" AvailableToClient="false">
          <Collection>
            <Fields>
              <FormField FieldID="ID" DataType="Guid" Caption="ID" CaptionResourceKey="$$id" />
              <FormField FieldID="DATATYPECODE" DataType="Integer" Caption="DATATYPECODE" CaptionResourceKey="$$datatypecode" />
              <FormField FieldID="CONSTITUENTSEARCHLISTCATALOGID" DataType="Guid" Caption="CONSTITUENTSEARCHLISTCATALOGID" CaptionResourceKey="$$constituentsearchlistcatalogid" />
              <FormField FieldID="CODETABLENAME" Caption="CODETABLENAME" CaptionResourceKey="$$codetablename" />
            </Fields>
          </Collection>
        </FormField>
        <FormField FieldID="COMMENT" MaxLength="255" Caption="Comment" CaptionResourceKey="$$comment" />
        <FormField FieldID="REMOVEUNQUALIFIED" DataType="Boolean" Caption="Remove attribute from unqualified records" CaptionResourceKey="$$remove_attribute_from_unqualified_records" />
        <FormField FieldID="OVERWRITEEXISTINGVALUE" DataType="Boolean" Caption="Overwrite existing values" DefaultValueText="true" CaptionResourceKey="$$overwrite_existing_values" />
        <FormField FieldID="CURRENCYID" DataType="Guid" Caption="Currency" CaptionResourceKey="$$currency">
          <SimpleDataList SimpleDataListID="13612288-b37e-409d-ba52-6ab31637ddd6" />
        </FormField>
        <FormField FieldID="STARTDATE" DataType="Date" Caption="Start date" CaptionResourceKey="$$start_date" />
        <FormField FieldID="ENDDATE" DataType="Date" Caption="End date" CaptionResourceKey="$$end_date" />
      </FormFields>
    </FormMetaData>
  </ParametersFormMetaData>
  
</GlobalChangeSpec>
